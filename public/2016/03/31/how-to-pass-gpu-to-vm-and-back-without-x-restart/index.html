<!DOCTYPE html>

<meta charset="utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta property="og:url" content="http://arseniyshestakov.com">


<meta property="og:type" content="article">
<meta property="og:title" content="How To: pass GPU to VM and back without X restart &middot; Personal website">

<meta property="og:site_name" content="Personal website">

<title>
    
    How To: pass GPU to VM and back without X restart
    
</title>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
<link rel="stylesheet" href="//yandex.st/highlightjs/8.0/styles/github.min.css">
<link rel="stylesheet" href="http://arseniyshestakov.com/css/styles.css">
<link rel="stylesheet" href="http://arseniyshestakov.com/css/custom.css">


<link rel="shortcut icon" href="http://arseniyshestakov.com/assets/favicon.ico">


<link rel="alternate" type="application/rss+xml" title="RSS" href="http://arseniyshestakov.com/index.xml">


<div class="container">
    <header class="nav">
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://arseniyshestakov.com">Personal website</a>
                </div>

                <div class="collapse navbar-collapse" id="navbar-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="http://arseniyshestakov.com/post">All Posts</a></li>
                        <li><a href="http://arseniyshestakov.com/tags">Tags</a></li>
                        
                        <li><a href="http://arseniyshestakov.com/about/">About me</a></li>
                        
                    </ul>

                    <ul class="nav navbar-nav navbar-right">
                        
                        
                        <li>
                            <a href="https://twitter.com/arsenyshestakov" target="_blank">
                                <i class="fa fa-twitter-square"></i>
                                Twitter</a>
                        </li>
                        
                        
                        <li>
                            <a href="https://github.com/arseniyshestakov" target="_blank">
                                <i class="fa fa-github-square"></i>
                                GitHub
                            </a>
                        </li>
                        
                        
                    </ul>
                </div>
            </div>
        </nav>
    </header>


<div class="row">
    <div class="col-md-8">
        <article class="post">

            <header>
                <div class="post-date">
                    <span class="glyphicon glyphicon-calendar"></span>
                    <time datetime="31 March 2016">
                        31 March 2016
                    </time>
                </div>
                <h1 class="post-title">
                    <a href="http://arseniyshestakov.com/2016/03/31/how-to-pass-gpu-to-vm-and-back-without-x-restart/">How To: pass GPU to VM and back without X restart</a>
                </h1>
            </header>

            <div class="post-content">
                

<p>TLDR: If you use FOSS drivers with DRI3 you now can do this:</p>

<ul>
<li>Use GPU on Linux for any 3D applications.</li>
<li>Pass it into VM and do anything with it.</li>
<li>Once VM is shutdown use GPU on host again.</li>
</ul>

<p>Everything without reboot and X server restart.</p>

<h2 id="long-story:78fead626a340942cdf0c7bfb7c93cd1">Long story:</h2>

<p>I&rsquo;m was using GPU passthrough with VFIO for two years now and happy with it. Still for me as Linux nerd that like to play around with FOSS drivers there was huge downside that once GPU used in VM it&rsquo;s was impossible to use it on host before reboot.</p>

<p>One year ago I did several attempts to make it work on Ubuntu 14.04 with 3.19 kernel, but failed. Radeon kernel module load and unload didn&rsquo;t end up well after few retries leaving me with locked host. I tested many different ideas, but none work and best I could achieve is getting GPU work after X server restart. Other VFIO users reported the same.</p>

<p>Now I&rsquo;m finally switch to Kubuntu 16.04 and after few days managed to get it working with stock everything and <a href="https://gist.github.com/cspicer/5e09d9ef382aa816435c">ACS kernel patch</a>. It&rsquo;s hard to say what exactly make it work, but suppose it&rsquo;s DRI3. My current setup looks that way:</p>

<ul>
<li>Host boot with UEFI. Used Legacy BOIS / CSM before.</li>
<li>Host monitors connected to iGPU. One connected to dGPU as well for usage in VM.</li>
<li>GPUs attached to radeon and intel kernel drivers. No blacklisting.</li>
<li>Radeon and Intel DDX drivers is set use DRI3.</li>
</ul>

<pre><code>/etc/X11/xorg.conf.d/10-intel.conf:
Section &quot;Device&quot;
    Identifier &quot;Intel Graphics&quot;
    Driver &quot;intel&quot;
    Option &quot;DRI&quot; &quot;3&quot;
EndSection

/etc/X11/xorg.conf.d/20-radeon.conf:
Section &quot;Device&quot;
    Identifier &quot;Radeon&quot;
    Driver &quot;radeon&quot;
    Option &quot;DRI3&quot; &quot;1&quot;
EndSection
</code></pre>

<ul>
<li>DRI_PRIME=1 to use dGPU on host:</li>
</ul>

<pre><code>DRI_PRIME=1 glxinfo | grep OpenGL
</code></pre>

<ul>
<li>To use in VM dGPU unbind from Radeon and bind to VFIO:</li>
</ul>

<pre><code>echo &quot;1002 6719&quot; &gt; /sys/bus/pci/drivers/vfio-pci/new_id
echo &quot;0000:01:00.0&quot; &gt; /sys/bus/pci/devices/0000:01:00.0/driver/unbind
echo &quot;0000:01:00.0&quot; &gt; /sys/bus/pci/drivers/vfio-pci/bind
echo &quot;1002 6719&quot; &gt; /sys/bus/pci/drivers/vfio-pci/remove_id

echo &quot;1002 aa80&quot; &gt; /sys/bus/pci/drivers/vfio-pci/new_id
echo &quot;0000:01:00.1&quot; &gt; /sys/bus/pci/devices/0000:01:00.1/driver/unbind
echo &quot;0000:01:00.1&quot; &gt; /sys/bus/pci/drivers/vfio-pci/bind
echo &quot;1002 aa80&quot; &gt; /sys/bus/pci/drivers/vfio-pci/remove_id
</code></pre>

<ul>
<li>After VM shutdown dGPU pass it back to Radeon.
Most reliable way I found is device removal and PCI rescan:</li>
</ul>

<pre><code>echo 1 &gt; /sys/bus/pci/devices/0000:01:00.0/remove
echo 1 &gt; /sys/bus/pci/devices/0000:01:00.1/remove
echo 1 &gt; /sys/bus/pci/rescan
</code></pre>

<p>So far I did several VM restarts switching GPU between host and VM and it&rsquo;s looks solid. I didn&rsquo;t tested everything, but Unigine Valley on both Windows VM and Linux as well as few games work stable. Hope others will be able to reproduce it with different hardware.</p>

<p>If you interested to see what hardware I use as well as QEMU configuration <a href="https://gist.github.com/ArseniyShestakov/dc152d080c65ebaa6781">you can find it on gist</a>. Since I just finish major upgrade VM still using BIOS, but, but once everything settle down I&rsquo;ll switch to use EFI/OVMF. For general information about GPU passthrough you can check <a href="http://vfio.blogspot.com/">Alex Williamson blog</a> and <a href="https://www.redhat.com/mailman/listinfo/vfio-users">vfio-users mailing list</a>.</p>

            </div>

            <aside>
                
                <ul class="list-inline post-tags">
                    
                    <li>
                        <a href="http://arseniyshestakov.com/tags/vfio">
                            <i class="fa fa-tags"></i>
                            vfio
                        </a>
                    </li>
                    
                    <li>
                        <a href="http://arseniyshestakov.com/tags/prime">
                            <i class="fa fa-tags"></i>
                            prime
                        </a>
                    </li>
                    
                    <li>
                        <a href="http://arseniyshestakov.com/tags/intel">
                            <i class="fa fa-tags"></i>
                            intel
                        </a>
                    </li>
                    
                    <li>
                        <a href="http://arseniyshestakov.com/tags/radeon">
                            <i class="fa fa-tags"></i>
                            radeon
                        </a>
                    </li>
                    
                </ul>

                
            
            <footer>

                <nav>
                    <ul class="pager">

                        
                        <li class="previous disabled"><a href="#"><span aria-hidden="true">&larr;</span> Older</a></li>
                        

                        <li><a href="http://arseniyshestakov.com/post">All Posts</a></li>

                        
                        <li class="next"><a href="http://arseniyshestakov.com/2015/12/23/experimental-static-website/">Newer <span aria-hidden="true">&rarr;</span></a></li>
                        

                    </ul>
                </nav>

                
                
                
                <div id="disqus_thread"></div>
                <script type="text/javascript">
 
var disqus_shortname = 'arseniyshestakov'; 

 
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                
                
            </footer>

        </article>
    </div>
    <div class="col-md-4">
        
<aside>
    <div class="row">

        <div class="col-xs-12 col-sm-4 col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title">Recent Posts</h2>
                </div>
                <div class="list-group">
                    
                    <a href="/2016/03/31/how-to-pass-gpu-to-vm-and-back-without-x-restart/" class="list-group-item">How To: pass GPU to VM and back without X restart</a>
                    
                    <a href="/2015/12/23/experimental-static-website/" class="list-group-item">Experimental static website</a>
                    
                    <a href="/about/" class="list-group-item">About me</a>
                    
                </div>
            </div>
        </div>

        <div class="col-xs-12 col-sm-4 col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2 class="panel-title">Tags</h2>
                </div>
                <div class="list-group">
                    
                    
                    
                    <a href="http://arseniyshestakov.com/tags/blog" class="list-group-item">
                        <span class="badge">1</span>
                        blog
                    </a>
                    
                    
                    <a href="http://arseniyshestakov.com/tags/hugo" class="list-group-item">
                        <span class="badge">1</span>
                        hugo
                    </a>
                    
                    
                    <a href="http://arseniyshestakov.com/tags/intel" class="list-group-item">
                        <span class="badge">1</span>
                        intel
                    </a>
                    
                    
                    <a href="http://arseniyshestakov.com/tags/prime" class="list-group-item">
                        <span class="badge">1</span>
                        prime
                    </a>
                    
                    
                    <a href="http://arseniyshestakov.com/tags/radeon" class="list-group-item">
                        <span class="badge">1</span>
                        radeon
                    </a>
                    
                    
                    <a href="http://arseniyshestakov.com/tags/vfio" class="list-group-item">
                        <span class="badge">1</span>
                        vfio
                    </a>
                    
                </div>
            </div>
        </div>

    </div>
</aside>

    </div>
</div>

</div>
<hr>

<footer class="container copy">
    <p>&copy; 2016  Arseniy Shestakov </p>
	<p>Powered by <a href="http://gohugo.io" target="_blank">Hugo</a></p>
	<p>Theme <a href="https://github.com/dim0627/hugo_theme_hugostrap" target="_blank">Hugostrap</a> designed by <a href="http://yet.unresolved.xyz" target="_blank">Daisuke Tsuji</a>, Inspired from <a href="https://github.com/kAworu/octostrap3" target="_blank">Octostrap3</a></p>
</footer>

<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script src="//yandex.st/highlightjs/8.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-71686871-1', 'auto');
ga('send', 'pageview');

</script>

<script>
document.write('<script src="//sharebutton.net/plugin/sharebutton.php?type=horizontal&u=' + encodeURIComponent(document.location.href) + '"></scr' + 'ipt>');
</script>

